# TASK-0014: Prefetching de imagem ao hover no card de profissional

## Metadata
- **ID**: TASK-0014
- **Branch**: feature/TASK-0014
- **Depends on**: TASK-0010, TASK-0011
- **PRD Reference**: PRD-0002
- **Quick Wins Cobertos**: MPF-006
- **Tempo Estimado**: 2-3h

## Objetivo

Implementar prefetching de imagem do profissional ao passar o mouse sobre o card, reduzindo o tempo percebido de navegacao ao clicar. Atualmente, recursos sao carregados apenas no momento do clique, causando delay perceptivel. O prefetch com debounce de 300ms evita fetches desnecessarios em hovers acidentais.

## Escopo Tecnico

### MPF-006: Prefetching ao hover no card

**Arquivos afetados:**
- `src/componentes/CardProfissional/CardProfissional.tsx` - adicionar handler onMouseEnter
- `src/App.tsx` - possivelmente ajustar callback de prefetch

**Estado atual (CardProfissional.tsx):**
O componente CardProfissional recebe dados do profissional e renderiza o card. Ao clicar, navega para a pagina do profissional. Nao ha nenhum prefetching implementado.

**Abordagem sugerida:**

1. **Adicionar handler `onMouseEnter` no CardProfissional:**
   - Ao hover, iniciar timer de 300ms
   - Apos 300ms, criar `new Image()` e atribuir `src` da foto do profissional
   - Isso forca o navegador a baixar a imagem e cachear

2. **Implementar debounce de 300ms:**
   - Usar `setTimeout` no `onMouseEnter`
   - Limpar timeout no `onMouseLeave` (cancelar prefetch se hover < 300ms)
   - Manter referencia do timeout com `useRef` para cleanup correto

3. **Evitar prefetches duplicados:**
   - Manter Set ou Map de URLs ja prefetchados (via `useRef`)
   - Se imagem ja foi prefetchada, nao repetir

4. **Cleanup no unmount:**
   - Limpar timeouts pendentes no `useEffect` cleanup

**Codigo conceitual:**
```typescript
const prefetchedRef = useRef<Set<string>>(new Set());
const timerRef = useRef<NodeJS.Timeout | null>(null);

const handleMouseEnter = () => {
  if (prefetchedRef.current.has(profissional.foto)) return;
  timerRef.current = setTimeout(() => {
    const img = new Image();
    img.src = profissional.foto;
    prefetchedRef.current.add(profissional.foto);
  }, 300);
};

const handleMouseLeave = () => {
  if (timerRef.current) {
    clearTimeout(timerRef.current);
    timerRef.current = null;
  }
};
```

**Edge cases a considerar:**
- Em dispositivos touch, `onMouseEnter` pode nao disparar ou disparar junto com click -- comportamento aceitavel pois prefetch nao causa efeito colateral
- Se imagem ja estiver em cache do navegador, o prefetch e no-op (sem impacto negativo)
- Verificar que o `src` da foto referencia o caminho correto (relativo vs absoluto)
- Cleanup de timeouts ao desmontar componente para evitar memory leaks
- Verificar que `profissional.foto` contem a URL correta da imagem SVG
- Apos TASK-0011 (otimizacao SVG), imagens serao menores, tornando prefetch ainda mais rapido
- O prefetch ocorre apenas para a imagem; os dados do profissional ja estao em memoria (mock data)

## Criterios de Aceitacao

- [ ] Ao manter hover por mais de 300ms sobre um card, imagem do profissional e precarregada
- [ ] Network tab do DevTools mostra request da imagem ao hover (nao ao click)
- [ ] Hover rapido (< 300ms) NAO dispara prefetch
- [ ] Navegacao ao clicar no card e mais rapida (imagem ja em cache)
- [ ] Nao ha prefetches duplicados (mesma imagem nao e baixada duas vezes)
- [ ] Nao ha memory leaks (timeouts limpos ao desmontar componente)
- [ ] `npm run build` executa sem erros
- [ ] `npm run lint` passa sem erros

## Test Strategy
- Unit tests: Nao
- API tests: Nao
- Integration tests: Nao
- Validacao manual: Sim - monitorar Network tab ao hover, verificar que imagem aparece como request separado, testar hover rapido vs lento, verificar que click apos hover e mais rapido

## Definition of Done
- [ ] Codigo implementado conforme especificacao
- [ ] Build passando (`npm run build` sem erros)
- [ ] Lint passando (`npm run lint` sem erros)
- [ ] Prefetch funcional verificado via DevTools Network
- [ ] Code review aprovado pelo Tech Lead
- [ ] QA validado pelo Tech Lead

## Status: DONE

## Code Review & QA (Consolidated) - 2026-02-08

### Resultado: APROVADO

**Build**: OK (vite v7.3.1, 57 modules, 521ms)
**Lint**: OK (0 warnings, 0 errors)
**ADR**: ADR-0008 criado

### Verificacao Tecnica
- [x] Prefetching de imagem implementado com debounce 300ms
- [x] Set para evitar prefetches duplicados
- [x] Cleanup de timeouts ao desmontar componente
- [x] Handlers onMouseEnter/onMouseLeave adicionados ao CardProfissional
- [x] Build passando sem erros
- [x] Lint passando sem erros

### Verificacao de Negocio (PRD-0002)
- [x] MPF-006: Prefetching ao hover - ATENDIDO
